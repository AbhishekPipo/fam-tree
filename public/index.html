<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Tree API Tester</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .header {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .section h3 {
            margin-top: 0;
            color: #34495e;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        input, select, button {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .result {
            background-color: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .success {
            background-color: #d5edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .family-tree {
            background-color: #e8f6f3;
            padding: 20px;
            border-radius: 5px;
            margin-top: 15px;
        }
        
        .family-member {
            background-color: white;
            padding: 10px;
            margin: 5px 0;
            border-left: 4px solid #3498db;
            border-radius: 3px;
        }
        
        .credentials {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .credentials h4 {
            margin-top: 0;
            color: #856404;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üå≥ Family Tree API Tester</h1>
            <p>Interactive tool to test the Family Tree Application API</p>
            <div style="margin-top: 15px;">
                <a href="/api-docs" target="_blank" style="background-color: #2980b9; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px; margin-right: 10px;">üìö API Documentation</a>
                <a href="/login.html" style="background-color: #8e44ad; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px; margin-right: 10px;">üîê Login</a>
                <a href="/dynamic_family_tree_graph.html" style="background-color: #e74c3c; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px; margin-right: 10px;">üåê Graph View</a>
                <a href="/api/health" target="_blank" style="background-color: #27ae60; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px;">üíä Health Check</a>
            </div>
        </div>

        <div class="credentials">
            <h4>üìù Sample Login Credentials:</h4>
            <ul>
                <li><strong>Email:</strong> prashanth@family.com | <strong>Password:</strong> FamilyTree123!</li>
                <li><strong>Email:</strong> anjali@family.com | <strong>Password:</strong> FamilyTree123!</li>
                <li><strong>Email:</strong> simran@family.com | <strong>Password:</strong> FamilyTree123!</li>
                <li><strong>Email:</strong> ramesh@family.com | <strong>Password:</strong> FamilyTree123!</li>
            </ul>
        </div>

        <div class="grid">
            <div class="section">
                <h3>üîê Authentication</h3>
                
                <div class="form-group">
                    <button onclick="testHealth()">Test Health Check</button>
                    <div id="healthResult" class="result" style="display: none;"></div>
                </div>

                <div class="form-group">
                    <label for="loginEmail">Email:</label>
                    <input type="email" id="loginEmail" value="prashanth@family.com">
                </div>
                
                <div class="form-group">
                    <label for="loginPassword">Password:</label>
                    <input type="password" id="loginPassword" value="FamilyTree123!">
                </div>
                
                <button onclick="login()">Login</button>
                <button onclick="logout()" id="logoutBtn" style="display: none;">Logout</button>
                
                <div id="loginResult" class="result" style="display: none;"></div>
            </div>

            <div class="section">
                <h3>üë§ User Profile</h3>
                
                <button onclick="getProfile()" id="profileBtn" disabled>Get Profile</button>
                
                <div class="form-group" style="margin-top: 15px;">
                    <label for="updateLocation">Location:</label>
                    <input type="text" id="updateLocation" placeholder="Enter new location">
                </div>
                
                <div class="form-group">
                    <label for="updateMedication">Has Medication:</label>
                    <select id="updateMedication">
                        <option value="false">No</option>
                        <option value="true">Yes</option>
                    </select>
                </div>
                
                <button onclick="updateProfile()" id="updateBtn" disabled>Update Profile</button>
                
                <div id="profileResult" class="result" style="display: none;"></div>
            </div>
        </div>

        <div class="section">
            <h3>üå≥ Family Tree</h3>
            
            <div class="grid">
                <div>
                    <button onclick="getFamilyTree()" id="treeBtn" disabled>Get Family Tree</button>
                    <button onclick="getAllMembers()" id="membersBtn" disabled>Get All Members</button>
                </div>
                
                <div>
                    <button onclick="showAddMemberForm()" id="addMemberBtn" disabled>Add Family Member</button>
                </div>
            </div>

            <div id="addMemberForm" style="display: none; margin-top: 20px; padding: 20px; background-color: #f8f9fa; border-radius: 5px;">
                <h4>Add New Family Member</h4>
                <div class="grid">
                    <div>
                        <div class="form-group">
                            <label for="newFirstName">First Name:</label>
                            <input type="text" id="newFirstName" required>
                        </div>
                        <div class="form-group">
                            <label for="newLastName">Last Name:</label>
                            <input type="text" id="newLastName" required>
                        </div>
                        <div class="form-group">
                            <label for="newEmail">Email:</label>
                            <input type="email" id="newEmail" required>
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label for="newGender">Gender:</label>
                            <select id="newGender" required>
                                <option value="">Select Gender</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="newRelationship">Relationship:</label>
                            <select id="newRelationship" required>
                                <option value="">Select Relationship</option>
                                <option value="father">Father</option>
                                <option value="mother">Mother</option>
                                <option value="son">Son</option>
                                <option value="daughter">Daughter</option>
                                <option value="brother">Brother</option>
                                <option value="sister">Sister</option>
                                <option value="husband">Husband</option>
                                <option value="wife">Wife</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="newBirthDate">Date of Birth:</label>
                            <input type="date" id="newBirthDate">
                        </div>
                    </div>
                </div>
                <button onclick="addFamilyMember()">Add Member</button>
                <button onclick="hideAddMemberForm()">Cancel</button>
            </div>

            <div id="familyResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        let authToken = localStorage.getItem('authToken');
        let currentUser = null;

        // Update UI based on auth state
        function updateUI() {
            const isLoggedIn = !!authToken;
            document.getElementById('logoutBtn').style.display = isLoggedIn ? 'inline-block' : 'none';
            document.getElementById('profileBtn').disabled = !isLoggedIn;
            document.getElementById('updateBtn').disabled = !isLoggedIn;
            document.getElementById('treeBtn').disabled = !isLoggedIn;
            document.getElementById('membersBtn').disabled = !isLoggedIn;
            document.getElementById('addMemberBtn').disabled = !isLoggedIn;
        }

        // Initialize
        updateUI();

        async function testHealth() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                showResult('healthResult', JSON.stringify(data, null, 2), 'success');
            } catch (error) {
                showResult('healthResult', `Error: ${error.message}`, 'error');
            }
        }

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                
                if (data.success) {
                    authToken = data.data.token;
                    currentUser = data.data.user;
                    localStorage.setItem('authToken', authToken);
                    showResult('loginResult', `Login successful!\nWelcome ${currentUser.firstName} ${currentUser.lastName}`, 'success');
                    updateUI();
                } else {
                    showResult('loginResult', `Login failed: ${data.message}`, 'error');
                }
            } catch (error) {
                showResult('loginResult', `Error: ${error.message}`, 'error');
            }
        }

        async function logout() {
            try {
                const response = await fetch(`${API_BASE}/auth/logout`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                
                authToken = null;
                currentUser = null;
                localStorage.removeItem('authToken');
                showResult('loginResult', 'Logged out successfully', 'success');
                updateUI();
            } catch (error) {
                showResult('loginResult', `Logout error: ${error.message}`, 'error');
            }
        }

        async function getProfile() {
            try {
                const response = await fetch(`${API_BASE}/auth/profile`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                showResult('profileResult', JSON.stringify(data.data.user, null, 2), 'success');
            } catch (error) {
                showResult('profileResult', `Error: ${error.message}`, 'error');
            }
        }

        async function updateProfile() {
            const location = document.getElementById('updateLocation').value;
            const hasMedication = document.getElementById('updateMedication').value === 'true';

            try {
                const response = await fetch(`${API_BASE}/auth/profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        location,
                        hasMedication
                    })
                });

                const data = await response.json();
                showResult('profileResult', JSON.stringify(data, null, 2), data.success ? 'success' : 'error');
            } catch (error) {
                showResult('profileResult', `Error: ${error.message}`, 'error');
            }
        }

        async function getFamilyTree() {
            try {
                const response = await fetch(`${API_BASE}/family/tree`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    const familyData = data.data;
                    let output = `Family Tree for ${familyData.currentUser.firstName} ${familyData.currentUser.lastName}\n`;
                    output += `Total Family Members: ${familyData.totalMembers}\n\n`;
                    
                    if (familyData.ancestors.length > 0) {
                        output += "üë¥üëµ ANCESTORS:\n";
                        familyData.ancestors.forEach(member => {
                            output += `  - ${member.user.firstName} ${member.user.lastName} (${member.relationship})\n`;
                        });
                        output += "\n";
                    }
                    
                    if (familyData.adjacent.length > 0) {
                        output += "üíë SPOUSE/PARTNER:\n";
                        familyData.adjacent.forEach(member => {
                            output += `  - ${member.user.firstName} ${member.user.lastName} (${member.relationship})\n`;
                        });
                        output += "\n";
                    }
                    
                    if (familyData.descendants.length > 0) {
                        output += "üë∂üëß DESCENDANTS:\n";
                        familyData.descendants.forEach(member => {
                            let parentInfo = '';
                            if (member.parentInfo) {
                                parentInfo = ` (via ${member.parentInfo.directParent.name})`;
                            }
                            output += `  - ${member.user.firstName} ${member.user.lastName} (${member.relationship})${parentInfo}\n`;
                        });
                    }
                    
                    showResult('familyResult', output, 'success');
                } else {
                    showResult('familyResult', `Error: ${data.message}`, 'error');
                }
            } catch (error) {
                showResult('familyResult', `Error: ${error.message}`, 'error');
            }
        }

        async function getAllMembers() {
            try {
                const response = await fetch(`${API_BASE}/family/members`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                showResult('familyResult', JSON.stringify(data, null, 2), data.success ? 'success' : 'error');
            } catch (error) {
                showResult('familyResult', `Error: ${error.message}`, 'error');
            }
        }

        function showAddMemberForm() {
            document.getElementById('addMemberForm').style.display = 'block';
        }

        function hideAddMemberForm() {
            document.getElementById('addMemberForm').style.display = 'none';
            // Clear form
            document.getElementById('newFirstName').value = '';
            document.getElementById('newLastName').value = '';
            document.getElementById('newEmail').value = '';
            document.getElementById('newGender').value = '';
            document.getElementById('newRelationship').value = '';
            document.getElementById('newBirthDate').value = '';
        }

        async function addFamilyMember() {
            const firstName = document.getElementById('newFirstName').value;
            const lastName = document.getElementById('newLastName').value;
            const email = document.getElementById('newEmail').value;
            const gender = document.getElementById('newGender').value;
            const relationshipType = document.getElementById('newRelationship').value;
            const dateOfBirth = document.getElementById('newBirthDate').value;

            if (!firstName || !lastName || !email || !gender || !relationshipType) {
                showResult('familyResult', 'Please fill in all required fields', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/family/member`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        firstName,
                        lastName,
                        email,
                        gender,
                        relationshipType,
                        dateOfBirth
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showResult('familyResult', `Family member added successfully!\n${JSON.stringify(data.data.user, null, 2)}`, 'success');
                    hideAddMemberForm();
                } else {
                    showResult('familyResult', `Error: ${data.message}`, 'error');
                }
            } catch (error) {
                showResult('familyResult', `Error: ${error.message}`, 'error');
            }
        }

        function showResult(elementId, content, type) {
            const element = document.getElementById(elementId);
            element.textContent = content;
            element.className = `result ${type}`;
            element.style.display = 'block';
        }
    </script>
</body>
</html>
